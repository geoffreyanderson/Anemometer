<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Anemometer by geoffreyanderson</title>
    
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Anemometer</h1>
        <p>Box SQL Slow Query Monitor</p>
        <p class="view"><a href="https://github.com/geoffreyanderson/Anemometer">View the Project on GitHub <small>geoffreyanderson/Anemometer</small></a></p>
        <ul>
          <li><a href="https://github.com/geoffreyanderson/Anemometer/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/geoffreyanderson/Anemometer/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/geoffreyanderson/Anemometer">Fork On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>Box Anemometer</h2>

<p>This is the Box Anemometer, the MySQL Slow Query Monitor.  This tool is used to analyze slow query logs collected from MySQL instances to identify problematic queries.</p>

<h3>Quickstart</h3>

<p>If you're just completely itching to start using this tool, here's what you need:</p>

<ol>
<li> a MySQL database to store query analysis data in.</li>
<li> <a href="http://www.percona.com/doc/percona-toolkit/pt-query-digest.html">pt-query-digest</a>.

<ul>
<li>  You may as well just get the whole <a href="http://www.percona.com/doc/percona-toolkit">Percona Toolkit</a> while you're at it :)</li>
</ul>
</li>
<li> a slow query log from a MySQL server (see <a href="http://dev.mysql.com/doc/refman/5.5/en/slow-query-log.html">The Slow Query Log</a> for info on getting one)</li>
<li> a webserver with PHP</li>
</ol><h4>Setup DB</h4>

<p>First up, you should connect to the MySQL database you're looking to store the analysis data in and issue the following command:</p>

<pre><code>$ mysql -h db.example.com &lt; install.sql
$ mysql -h db.example.com -e "grant ALL ON `slow_query_log`.* to 'anemometer'@'%' IDENTIFIED BY 'superSecurePass';"
</code></pre>

<h4>Put some data in the DB</h4>

<p>Next, grab that slow query log file you have (mine's called "slow.log"!), and run pt-query-digest on it:
<strong>NOTE:</strong> I'm using a BASH 3.0 shell here on my MySQL database server! This is so the "$HOSTNAME" variable properly replaces with "db.example.com")</p>

<pre><code>$ pt-query-digest --user=anemometer --password=superSecurePass \
                  --review h=db.example.com,D=slow_query_log,t=global_query_review \
                  --review-history h=db.example.com,D=slow_query_log,t=global_query_review_history \
                  --no-report --limit=0% \ 
                  --filter=" \$event-&gt;{Bytes} = length(\$event-&gt;{arg}) and \$event-&gt;{hostname}=\"$HOSTNAME\"" \ 
                  /var/lib/mysql/db.example.com-slow.log
Pipeline process 11 (aggregate fingerprint) caused an error: Argument "57A" isn't numeric in numeric gt (&gt;) at (eval 40) line 6, &lt;&gt; line 27.
Pipeline process 11 (aggregate fingerprint) caused an error: Argument "57B" isn't numeric in numeric gt (&gt;) at (eval 40) line 6, &lt;&gt; line 28.
Pipeline process 11 (aggregate fingerprint) caused an error: Argument "57C" isn't numeric in numeric gt (&gt;) at (eval 40) line 6, &lt;&gt; line 29.
</code></pre>

<p>You may see an error like above, that's okay!.
TODO: explain what the options above are doing.</p>

<h4>View the data!</h4>

<p>Now, navigate to the web root of your apache server and snag a copy of the Box Anemometer code. Then copy the sample config so you can edit it:</p>

<pre><code>$ git clone git@github.com:box/Anemometer.git anemometer
$ cd anemometer/conf
$ cp sample.config.inc.php config.inc.php 
</code></pre>

<p>The sample config explains every setting you may want to change in it.  At the very least, make sure you set the Datasource to the MySQL database you're storing the analyzed digest information in:</p>

<pre><code>$conf['datasources']['locahost'] = array(
    'host'  =&gt; 'db.example.com',
    'port'  =&gt; 3306,
    'db'    =&gt; 'slow_query_log',
    'user'  =&gt; 'anemometer',
    'password' =&gt; 'superSecurePass',
    'tables' =&gt; array(
        'global_query_review' =&gt; 'fact',
        'global_query_review_history' =&gt; 'dimension'
    )
);
</code></pre>

<p>In addition, the "explain" plugin is enabled by default in the current release and you'll need to setup the username and password it uses to an account that has privileges to explain queries on a given schema on a host.  For example, if you're digesting slow logs that primarily contain queries from the "world" database on db.example.com, you'll need to ensure that the user account you put into the following section of the config has the necessary privileges on the "world" database on db.example.com.  To do this, scroll down in the sample config to the section containing the plugins configuration and change the 'user' and 'password' parameters to an appropriate account:</p>

<pre><code>$conf['plugins'] = array(
        ...
    'explain'       =&gt;      function ($sample) {
        $conn['user'] = 'anemometer';
        $conn['password'] = 'superSecurePass';

        return $conn;
    },
);
</code></pre>

<p>Now you should be able to navigate to your webserver in a browser and see Box Anemometer in action!</p>

<h3>Phpdocs</h3>

<p>Phpdocs for this tool can be found in the "docs" sub-directory of the project.</p>

<h3>Dependencies</h3>

<p>This application requires an Apache webserver with PHP and a MySQL database that contains the data aggregated from MySQL slow query logs.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/geoffreyanderson">geoffreyanderson</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>